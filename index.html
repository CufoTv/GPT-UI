<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GPT-5o ChatBot (Demo)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Material icons -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
  <style>/* ==============================================
   Reset & Base Styles
============================================== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

html, body {
  height: 100%;
  width: 100%;
  scroll-behavior: smooth;
  transition: background 0.3s, color 0.3s;
}

body {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  background: linear-gradient(135deg, #1e1e2f, #2c2c3e);
  color: #fff;
  padding: 10px;
  overflow-x: hidden;
}

body.light-mode {
  background: linear-gradient(135deg, #f2f2f2, #ffffff);
  color: #222;
}

a { text-decoration: none; color: inherit; }
button { cursor: pointer; outline: none; border: none; }

/* ==============================================
   Chat App Container
============================================== */
.chat-app {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 950px;
  height: 95vh;
  border-radius: 20px;
  overflow: hidden;
  background: linear-gradient(135deg, #2c2c3e, #1e1e2f);
  box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  transition: all 0.3s ease;
  animation: fadeIn 0.6s ease forwards;
}

body.light-mode .chat-app {
  background: linear-gradient(135deg, #fff, #f0f0f0);
}

/* ==============================================
   Profile Panel & Admin Panel
============================================== */
#profile-panel {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: #3b3b55;
  border-bottom: 1px solid #444;
  transition: all 0.3s ease;
  animation: slideDown 0.3s ease forwards;
}

body.light-mode #profile-panel {
  background: #eaeaea;
  color: #222;
}

#profile-panel span {
  font-weight: bold;
  font-size: 1rem;
}

#admin-panel {
  display: flex;
  flex-direction: column;
  margin-top: 10px;
  transition: all 0.3s ease;
}

#admin-panel input,
#admin-panel button {
  padding: 10px 14px;
  margin-bottom: 8px;
  border-radius: 12px;
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

#admin-panel input:focus {
  box-shadow: 0 0 10px #6c9cff;
}

#admin-panel button {
  background: #ff7f50;
  color: #fff;
  font-weight: 600;
  transition: all 0.3s ease;
}

#admin-panel button:hover {
  background: #ff956a;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255,127,80,0.5);
}

/* ==============================================
   Chat Container
============================================== */
.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  overflow-y: auto;
  background: #1f1f2c;
  border-radius: 0;
  transition: all 0.3s ease;
  scrollbar-width: thin;
}

body.light-mode .chat-container {
  background: #f9f9f9;
}

/* Custom Scrollbar Desktop */
.chat-container::-webkit-scrollbar {
  width: 10px;
}
.chat-container::-webkit-scrollbar-track {
  background: #2c2c3e;
  border-radius: 5px;
}
.chat-container::-webkit-scrollbar-thumb {
  background: #6c9cff;
  border-radius: 5px;
}
body.light-mode .chat-container::-webkit-scrollbar-track { background: #eee; }
body.light-mode .chat-container::-webkit-scrollbar-thumb { background: #84aaff; }

/* ==============================================
   Chat Bubbles
============================================== */
.chat {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  opacity: 0;
  animation: fadeInUp 0.5s forwards;
}

.chat.outgoing {
  flex-direction: row-reverse;
}

.bubble {
  max-width: 70%;
  padding: 14px 22px;
  border-radius: 25px;
  background: #4c4c6a;
  color: #fff;
  font-size: 0.95rem;
  line-height: 1.5;
  word-wrap: break-word;
  position: relative;
  transition: all 0.3s ease;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}

body.light-mode .bubble { background: #d9d9ff; color: #222; }
.chat.outgoing .bubble { background: #6c9cff; }

.chat:hover .bubble {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(108,156,255,0.4);
}

.chat img.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.chat img.avatar:hover { transform: scale(1.05); }

/* ==============================================
   Typing Animation
============================================== */
.typing-animation {
  display: flex;
  gap: 4px;
  align-items: center;
  height: 18px;
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #fff;
  animation: typing 1s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
body.light-mode .typing-dot { background: #222; }

@keyframes typing {
  0%,60%,100% { transform: translateY(0); opacity: 0.3; }
  30% { transform: translateY(-5px); opacity: 1; }
}

/* ==============================================
   Input Area
============================================== */
.input-area {
  display: flex;
  gap: 10px;
  padding: 15px;
  background: #2c2c3e;
  border-top: 1px solid #444;
  transition: all 0.3s ease;
}

body.light-mode .input-area { background: #eee; }

.input-area input {
  flex: 1;
  padding: 14px 18px;
  border-radius: 25px;
  border: none;
  background: rgba(255,255,255,0.05);
  color: inherit;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.input-area input:focus {
  background: rgba(255,255,255,0.15);
  box-shadow: 0 0 8px #6c9cff;
}

body.light-mode .input-area input { background: rgba(0,0,0,0.05); }

.input-area button {
  padding: 12px 24px;
  border-radius: 25px;
  background: #6c9cff;
  font-weight: bold;
  transition: all 0.3s ease;
}

.input-area button:hover {
  transform: translateY(-2px);
  background: #84aaff;
  box-shadow: 0 4px 15px rgba(108,156,255,0.5);
}

/* ==============================================
   Default Text
============================================== */
.default-text {
  text-align: center;
  opacity: 0.6;
  animation: fadeIn 0.5s ease forwards;
}

/* ==============================================
   Animations & Shadows
============================================== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ==============================================
   Responsive & Mobile-First
============================================== */
@media (max-width: 1024px) {
  .chat-app { max-width: 90%; }
  .bubble { max-width: 75%; font-size: 0.95rem; }
}

@media (max-width: 768px) {
  .chat-app { height: 90vh; }
  #profile-panel { flex-direction: column; align-items: flex-start; gap: 8px; }
  .bubble { max-width: 80%; }
}

@media (max-width: 480px) {
  .chat-app { width: 100%; height: 95vh; border-radius: 15px; }
  .bubble { max-width: 90%; font-size: 0.9rem; }
  .input-area input { font-size: 0.95rem; }
  .input-area button { font-size: 0.95rem; padding: 10px 18px; }
  #admin-panel input, #admin-panel button { font-size: 0.9rem; }
}

/* ==============================================
   Animated Background Gradient
============================================== */
body {
  background: linear-gradient(-45deg, #1e1e2f, #2c2c3e, #3b3b55, #2c2c3e);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
}

@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ==============================================
   Extra UX Microinteractions
============================================== */
.bubble::after {
  content: "";
  position: absolute;
  width: 10px; height: 10px;
  background: inherit;
  bottom: -5px;
  left: 10px;
  clip-path: polygon(50% 0, 0% 100%, 100% 100%);
  opacity: 0.8;
  transition: all 0.3s ease;
}

.chat.outgoing .bubble::after {
  left: auto; right: 10px;
}

.chat:hover .bubble::after {
  transform: translateY(-2px);
}

#model-select {
  padding: 10px 14px;
  border-radius: 12px;
  background: #444;
  color: #fff;
  transition: all 0.3s ease;
}

#model-select:hover { box-shadow: 0 0 10px #6c9cff; }
body.light-mode #model-select { background: #ddd; color: #222; }

/* ====== END OF RESPONSIVE, DYNAMIC, ANIMATED UX/UI ====== */</style>
</head>
<body>
  <div id="app">
    <!-- Left: auth / profile / admin -->
    <aside class="sidebar">
      <div class="brand">
        <h2>GPT-5o</h2>
        <p class="subtitle">Chat demo</p>
      </div>

      <div id="auth-container">
        <!-- Login form -->
        <div id="login-form" class="auth-box">
          <h3>Login</h3>
          <input id="login-email" placeholder="Email" type="email" />
          <input id="login-pass" placeholder="Password" type="password" />
          <button id="login-btn">Login</button>
          <p class="small">No account? <a href="#" id="show-signup">Sign up</a></p>
        </div>

        <!-- Signup -->
        <div id="signup-form" class="auth-box hidden">
          <h3>Sign up</h3>
          <input id="signup-name" placeholder="Full name" type="text" />
          <input id="signup-email" placeholder="Email" type="email" />
          <input id="signup-pass" placeholder="Password" type="password" />
          <button id="signup-btn">Create account</button>
          <p class="small">Have account? <a href="#" id="show-login">Login</a></p>
        </div>
      </div>

      <div id="profile-panel" class="hidden">
        <div class="profile">
          <img src="profile/user.jpg" alt="avatar" />
          <div>
            <div id="welcome-line">Welcome, User</div>
            <div id="email-line" class="small dim"></div>
          </div>
        </div>

        <div class="model-block">
          <label>Active model:</label>
          <div class="model-controls">
            <select id="model-select">
              <option value="GPT-5o">GPT-5o</option>
              <option value="GPT-5o-mini">GPT-5o-mini</option>
            </select>
            <button id="logout-btn" class="btn-ghost">Logout</button>
          </div>
          <div class="small dim">Free: 20 messages/hour on GPT-5o, auto-switch to GPT-5o-mini after limit. Paid: unlimited and can switch anytime.</div>
        </div>

        <div id="admin-panel" class="hidden">
          <h4>Admin</h4>
          <div>Make user paid (by email):</div>
          <input id="admin-user-email" placeholder="user email" />
          <button id="admin-mark-paid">Mark Paid</button>
          <div class="small dim">Seed admin: admin@gmail.com / Admin123</div>
        </div>

        <div id="usage-stats" class="stats">
          <div>Messages this hour: <span id="msg-count">0</span></div>
          <div>Model: <span id="current-model-display">GPT-5o</span></div>
        </div>

        <div class="small dim" style="margin-top:12px;">
          App stores signups in this browser (localStorage). To persist to a server you'd need a backend.
        </div>
      </div>
    </aside>

    <!-- Right: chat -->
    <main class="main">
      <div class="chat-container"></div>

      <div class="typing-container">
        <div class="typing-content">
          <div class="typing-textarea">
            <textarea id="chat-input" spellcheck="false" placeholder="Ask a question..." required></textarea>
            <span id="send-btn" class="material-symbols-rounded">send</span>
          </div>
          <div class="typing-controls">
            <span id="theme-btn" class="material-symbols-rounded">light_mode</span>
            <span id="delete-btn" class="material-symbols-rounded">delete</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>// script.js
// Main client-side demo implementing signup/login, free/paid models, message limits, and chat logic.

// ======= Elements =======
const loginForm = document.getElementById("login-form");
const signupForm = document.getElementById("signup-form");
const showSignupLink = document.getElementById("show-signup");
const showLoginLink = document.getElementById("show-login");
const loginBtn = document.getElementById("login-btn");
const signupBtn = document.getElementById("signup-btn");
const logoutBtn = document.getElementById("logout-btn");

const loginEmail = document.getElementById("login-email");
const loginPass = document.getElementById("login-pass");
const signupName = document.getElementById("signup-name");
const signupEmail = document.getElementById("signup-email");
const signupPass = document.getElementById("signup-pass");

const profilePanel = document.getElementById("profile-panel");
const welcomeLine = document.getElementById("welcome-line");
const emailLine = document.getElementById("email-line");
const modelSelect = document.getElementById("model-select");
const adminPanel = document.getElementById("admin-panel");
const adminMarkPaidBtn = document.getElementById("admin-mark-paid");
const adminUserEmailInput = document.getElementById("admin-user-email");
const msgCountEl = document.getElementById("msg-count");
const currentModelDisplay = document.getElementById("current-model-display");

const chatContainer = document.querySelector(".chat-container");
const chatInput = document.getElementById("chat-input");
const sendButton = document.getElementById("send-btn");
const themeBtn = document.getElementById("theme-btn");
const deleteBtn = document.getElementById("delete-btn");

// ======= App state =======
let qaData = { "GPT-5o": [] }; // loaded from gpt-5o.json
let seededUsers = []; // initial users from data.json seed
let currentUser = null; // { name, email, passwordHash, paid:bool, createdAt, messageLog: [] }
let isBotTyping = false;

// constants
const FREE_LIMIT_PER_HOUR = 20;
const MODEL_PREMIUM = "GPT-5o";
const MODEL_CHEAP = "GPT-5o-mini";

// ======= Utility helpers =======
function $(sel){ return document.querySelector(sel); }
function saveUsersToLocal(users) {
  localStorage.setItem("users", JSON.stringify(users));
}
function loadUsersFromLocal() {
  try { return JSON.parse(localStorage.getItem("users") || "[]"); } catch(e){ return []; }
}
function setCurrentUser(user) {
  currentUser = user;
  localStorage.setItem("currentUser", JSON.stringify(user));
}
function getCurrentUserFromStorage() {
  try { return JSON.parse(localStorage.getItem("currentUser") || "null"); } catch(e){ return null; }
}
function hashSimple(s) { return btoa(s); } // demo only, not secure

// ======= Message tracking =======
function recordMessageSent(user) {
  if (!user.messageLog) user.messageLog = [];
  user.messageLog.push(Date.now());
  const users = loadUsersFromLocal();
  const idx = users.findIndex(u => u.email === user.email);
  if (idx !== -1) {
    users[idx] = user;
    saveUsersToLocal(users);
  }
  setCurrentUser(user);
}

function messagesInLastHour(user) {
  if (!user || !user.messageLog) return 0;
  const oneHourAgo = Date.now() - (60 * 60 * 1000);
  user.messageLog = user.messageLog.filter(ts => ts >= oneHourAgo);
  return user.messageLog.length;
}

function updateModelAndStatsUI() {
  if (!currentUser) return;
  const count = messagesInLastHour(currentUser);
  msgCountEl.textContent = count;

  if (!currentUser.paid) {
    if (count >= FREE_LIMIT_PER_HOUR) {
      currentUser.activeModel = MODEL_CHEAP;
      modelSelect.value = MODEL_CHEAP;
      modelSelect.disabled = true;
    } else {
      if (!currentUser.activeModel) currentUser.activeModel = MODEL_PREMIUM;
      modelSelect.value = currentUser.activeModel;
      modelSelect.disabled = true;
    }
  } else {
    currentUser.activeModel = currentUser.activeModel || MODEL_PREMIUM;
    modelSelect.value = currentUser.activeModel;
    modelSelect.disabled = false;
  }

  currentModelDisplay.textContent = currentUser.activeModel || MODEL_PREMIUM;
  setCurrentUser(currentUser);
}

// ======= Load initial JSONs =======
async function loadSeedData() {
  try {
    const res = await fetch("data.json");
    if (res.ok) {
      const d = await res.json();
      seededUsers = d.users || [];
      const localUsers = loadUsersFromLocal();
      seededUsers.forEach(su => {
        if (!localUsers.some(u => u.email === su.email)) {
          localUsers.push(su);
        }
      });
      saveUsersToLocal(localUsers);
    }
  } catch(e) { console.warn("No data.json found, continuing."); }

  try {
    const r = await fetch("gpt-5o.json");
    if (r.ok) {
      qaData = await r.json();
    }
  } catch(e) { console.error("Could not load gpt-5o.json:", e); }
}

// ======= Auth UI wiring =======
showSignupLink?.addEventListener("click", e => {
  e.preventDefault();
  loginForm.classList.add("hidden");
  signupForm.classList.remove("hidden");
});
showLoginLink?.addEventListener("click", e => {
  e.preventDefault();
  signupForm.classList.add("hidden");
  loginForm.classList.remove("hidden");
});

signupBtn.addEventListener("click", () => {
  const name = signupName.value.trim();
  const email = signupEmail.value.trim().toLowerCase();
  const pass = signupPass.value;
  if (!name || !email || !pass) { alert("Fill all fields"); return; }
  const users = loadUsersFromLocal();
  if (users.some(u => u.email === email)) { alert("Email already in use"); return; }
  const newUser = { name, email, passwordHash: hashSimple(pass), paid:false, createdAt: Date.now(), messageLog: [], activeModel: MODEL_PREMIUM };
  users.push(newUser);
  saveUsersToLocal(users);
  setCurrentUser(newUser);
  showProfileForUser(newUser);
  signupForm.classList.add("hidden"); loginForm.classList.add("hidden");
});

loginBtn.addEventListener("click", () => {
  const email = loginEmail.value.trim().toLowerCase();
  const pass = loginPass.value;
  const users = loadUsersFromLocal();
  const found = users.find(u => u.email === email && u.passwordHash === hashSimple(pass));
  if (!found) { alert("Invalid credentials"); return; }
  setCurrentUser(found);
  showProfileForUser(found);
});

logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("currentUser");
  currentUser = null;
  profilePanel.classList.add("hidden");
  loginForm.classList.remove("hidden");
  signupForm.classList.add("hidden");
});

adminMarkPaidBtn?.addEventListener("click", () => {
  const email = adminUserEmailInput.value.trim().toLowerCase();
  if (!email) return alert("Enter email");
  const users = loadUsersFromLocal();
  const idx = users.findIndex(u => u.email === email);
  if (idx === -1) return alert("User not found");
  users[idx].paid = true;
  saveUsersToLocal(users);
  alert(`${email} is now marked paid.`);
});

modelSelect.addEventListener("change", () => {
  if (!currentUser) return;
  if (!currentUser.paid) { modelSelect.value = currentUser.activeModel; return; }
  currentUser.activeModel = modelSelect.value;
  setCurrentUser(currentUser);
  updateModelAndStatsUI();
});

// ======= Chat logic =======
function buildMarkovChain(textArray) {
  const markov = {};
  textArray.forEach(sentence => {
    if (!sentence) return;
    const words = sentence.split(/\s+/).filter(Boolean);
    for (let i=0;i<words.length-1;i++){
      const w = words[i].toLowerCase();
      const nw = words[i+1].toLowerCase();
      if (!markov[w]) markov[w]=[];
      markov[w].push(nw);
    }
  });
  return markov;
}
function generateMarkovResponse(chain, startWord=null, length=30) {
  const keys = Object.keys(chain);
  if (!keys.length) return "";
  let word = startWord && chain[startWord] ? startWord : keys[Math.floor(Math.random()*keys.length)];
  const out = [word];
  for (let i=0;i<length;i++){
    const next = chain[word];
    if (!next || !next.length) break;
    word = next[Math.floor(Math.random()*next.length)];
    out.push(word);
  }
  return out.join(" ");
}
function similarity(a,b){
  const aw = a.toLowerCase().split(/\s+/);
  const bw = b.toLowerCase().split(/\s+/);
  const inter = aw.filter(x=>bw.includes(x));
  return inter.length / Math.max(1, Math.max(aw.length, bw.length));
}

// === Pipeline ===
function generateAnswerPipeline(question, activeModel) {
  const qaItems = qaData["GPT-5o"] || [];
  const q = question.trim().toLowerCase();
  let exactMatches = qaItems.filter(it => it.question.toLowerCase() === q);

  function weightedPick(items, qtext) {
    if (!items.length) return null;
    if (items.length===1) return items[0];
    const weights = items.map(it=>{
      const overlap = qtext.split(/\s+/).filter(w=>it.question.toLowerCase().includes(w)).length;
      return overlap+1;
    });
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum;
    for (let i=0;i<items.length;i++){ r-=weights[i]; if (r<=0) return items[i]; }
    return items[0];
  }

  if (exactMatches.length) {
    const sel = weightedPick(exactMatches, q);
    const others = exactMatches.filter(it=>it.answer!==sel.answer).map(it=>it.answer);
    if (others.length) {
      const chain = buildMarkovChain([sel.answer].concat(others));
      const length = activeModel===MODEL_PREMIUM ? 50 : 20;
      return generateMarkovResponse(chain, sel.answer.split(" ")[0].toLowerCase(), length);
    } else {
      if (activeModel===MODEL_PREMIUM) {
        const chain = buildMarkovChain([sel.answer]);
        return generateMarkovResponse(chain, sel.answer.split(" ")[0].toLowerCase(), Math.min(40, sel.answer.split(" ").length+10)) || sel.answer;
      } else return sel.answer;
    }
  } else {
    const sims = qaItems.map(it=>({it,score:similarity(q,it.question)}));
    const maxScore = Math.max(...sims.map(s=>s.score),0);
    if (maxScore>0) {
      const top = sims.filter(s=>s.score===maxScore).map(s=>s.it);
      const sel = weightedPick(top,q);
      const related = qaItems.filter(it=>top.some(t=>t.question===it.question)).map(it=>it.answer);
      if (related.length>1) {
        const chain = buildMarkovChain(related);
        const length = activeModel===MODEL_PREMIUM?45:18;
        return generateMarkovResponse(chain, sel.answer.split(" ")[0].toLowerCase(), length);
      } else return sel.answer;
    } else {
      const unmatched = JSON.parse(localStorage.getItem("unmatchedQuestions")||"[]");
      unmatched.push(question);
      localStorage.setItem("unmatchedQuestions", JSON.stringify(unmatched));
      return activeModel===MODEL_PREMIUM
        ? "I don't know that yet, but here's a general helpful explanation."
        : "Sorry, I don't know that.";
    }
  }
}

// gradual display
function displayTextGradually(element, text, onDone) {
  const words = text.split(/\s+/).filter(Boolean);
  let i=0;
  const delay=100;
  function step(){
    if (i>=words.length) { onDone&&onDone(); return; }
    const chunk = Math.min(words.length-i, Math.floor(Math.random()*3)+2);
    const slice = words.slice(i,i+chunk).join(" ");
    element.textContent += (element.textContent ? " " : "") + slice;
    i+=chunk; setTimeout(step,delay);
  }
  step();
}

// bot response
function showBotResponse(question) {
  if (!currentUser) return;
  isBotTyping = true;
  const incomingDiv = document.createElement("div");
  incomingDiv.classList.add("chat");
  const img = document.createElement("img"); img.src="profile/gpt-5o.jpg"; img.className="avatar";
  const bubble = document.createElement("div"); bubble.className="bubble";
  const typingWrap = document.createElement("div");
  typingWrap.className="typing-animation";
  typingWrap.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  bubble.appendChild(typingWrap);
  incomingDiv.appendChild(img); incomingDiv.appendChild(bubble);
  chatContainer.appendChild(incomingDiv); chatContainer.scrollTop=chatContainer.scrollHeight;

  updateModelAndStatsUI();
  const activeModel = currentUser.activeModel || (currentUser.paid?MODEL_PREMIUM:MODEL_PREMIUM);

  setTimeout(()=>{
    bubble.innerHTML="";
    const p=document.createElement("p"); bubble.appendChild(p);
    const response = generateAnswerPipeline(question,activeModel);
    displayTextGradually(p,response,()=>{
      isBotTyping=false;
      persistChatHTMLForUser();
      updateModelAndStatsUI();
      chatContainer.scrollTop=chatContainer.scrollHeight;
    });
  },700);
}

// chat persistence
function persistChatHTMLForUser() {
  if (!currentUser) return;
  const html = chatContainer.innerHTML;
  const users=loadUsersFromLocal();
  const idx=users.findIndex(u=>u.email===currentUser.email);
  if (idx!==-1) { users[idx].chatHTML=html; saveUsersToLocal(users); }
  setCurrentUser({...currentUser, chatHTML:html});
}
function loadChatForUser(user) {
  if (!user) return;
  const users=loadUsersFromLocal();
  const found=users.find(u=>u.email===user.email);
  if (found?.chatHTML) chatContainer.innerHTML=found.chatHTML;
  else chatContainer.innerHTML=`<div class="default-text"><h1>GPT-5o ChatBot</h1><p>Start chatting.</p></div>`;
  chatContainer.scrollTop=chatContainer.scrollHeight;
}

// send handler
sendButton.addEventListener("click",()=>handleSend());
chatInput.addEventListener("keydown",e=>{
  if (e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); handleSend(); }
});
function handleSend(){
  if (isBotTyping) return;
  if (!currentUser){ alert("Please login or signup."); return; }
  const text=chatInput.value.trim(); if (!text) return;
  const outDiv=document.createElement("div"); outDiv.classList.add("chat","outgoing");
  const img=document.createElement("img"); img.src="profile/user.jpg"; img.className="avatar";
  const bubble=document.createElement("div"); bubble.className="bubble"; bubble.textContent=text;
  outDiv.appendChild(img); outDiv.appendChild(bubble);
  chatContainer.appendChild(outDiv); chatContainer.scrollTop=chatContainer.scrollHeight;
  chatInput.value="";
  recordMessageSent(currentUser); updateModelAndStatsUI();
  setTimeout(()=>showBotResponse(text),300);
}

// delete chat
deleteBtn.addEventListener("click",()=>{
  if (!currentUser) return;
  if (!confirm("Delete all chats?")) return;
  const users=loadUsersFromLocal();
  const idx=users.findIndex(u=>u.email===currentUser.email);
  if (idx!==-1){ users[idx].chatHTML=""; saveUsersToLocal(users); }
  currentUser.chatHTML=""; setCurrentUser(currentUser);
  loadChatForUser(currentUser);
});

// theme toggle
themeBtn.addEventListener("click",()=>{ document.body.classList.toggle("light-mode"); });

// profile UI
function showProfileForUser(user){
  if (!user) return;
  profilePanel.classList.remove("hidden");
  loginForm.classList.add("hidden"); signupForm.classList.add("hidden");
  welcomeLine.textContent=(user.email==="admin@gmail.com")?"Welcome, Admin":`Welcome, ${user.name}`;
  emailLine.textContent=user.email;
  if (user.email==="admin@gmail.com") adminPanel.classList.remove("hidden");
  else adminPanel.classList.add("hidden");
  updateModelAndStatsUI(); loadChatForUser(user);
}

// init
(async function init(){
  await loadSeedData();
  const users=loadUsersFromLocal();
  if (!users.some(u=>u.email==="admin@gmail.com")){
    users.push({ name:"Admin", email:"admin@gmail.com", passwordHash:hashSimple("Admin123"), paid:true, createdAt:Date.now(), messageLog:[], activeModel:MODEL_PREMIUM });
    saveUsersToLocal(users);
  }
  const stored=getCurrentUserFromStorage();
  if (stored){ const all=loadUsersFromLocal(); const found=all.find(u=>u.email===stored.email); if (found){ setCurrentUser(found); showProfileForUser(found); } }
  else loginForm.classList.remove("hidden");
})();</script>
</body>
</html>
